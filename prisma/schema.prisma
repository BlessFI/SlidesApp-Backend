generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String           @id @default(cuid())
  email     String           @unique
  password  String
  name      String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  events    Event[]
  purchases Purchase[]
  reports   Report[]
  profiles  UserAppProfile[]
  videos    Video[]          @relation("VideoCreator")
  votes     Vote[]
}

model App {
  id            String           @id @default(cuid())
  name          String
  slug          String           @unique
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  events        Event[]
  purchases     Purchase[]
  reports       Report[]
  taxonomyNodes TaxonomyNode[]
  profiles      UserAppProfile[]
  videoAssets   VideoAsset[]
  videos        Video[]
  votes         Vote[]
}

model UserAppProfile {
  id          String   @id @default(cuid())
  userId      String
  appId       String
  role        String?  @default("user")
  displayName String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  app         App      @relation(fields: [appId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, appId])
  @@map("user_app_profiles")
}

model TaxonomyNode {
  id               String         @id @default(uuid()) @db.Uuid
  appId            String         @map("app_id")
  kind             String
  name             String
  slug             String?
  parentId         String?        @map("parent_id") @db.Uuid
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")
  app              App            @relation(fields: [appId], references: [id], onDelete: Cascade)
  parent           TaxonomyNode?  @relation("TaxonomyHierarchy", fields: [parentId], references: [id])
  children         TaxonomyNode[] @relation("TaxonomyHierarchy")

  @@unique([appId, kind, slug])
  @@map("taxonomy_nodes")
}

model Video {
  id             String        @id @default(uuid()) @db.Uuid
  appId          String        @map("app_id")
  creatorId      String        @map("creator_id")
  status         String        @default("ready")
  title          String?
  description    String?
  categoryIds    String[]      @default([]) @map("category_ids")
  topicIds       String[]      @default([]) @map("topic_ids")
  subjectIds     String[]      @default([]) @map("subject_ids")
  durationMs     Int           @map("duration_ms")
  aspectRatio    Decimal?      @map("aspect_ratio") @db.Decimal(4, 2)
  primaryAssetId String?       @map("primary_asset_id") @db.Uuid
  rankingScore   Float         @default(0) @map("ranking_score")
  likeCount      Int           @default(0) @map("like_count")
  upVoteCount    Int           @default(0) @map("up_vote_count")
  superVoteCount Int           @default(0) @map("super_vote_count")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")
  copyright      String?
  credit         String?
  guid           String?
  keywords       String?
  license        String?
  link           String?
  pubDate        DateTime?     @map("pub_date")
  rating         String?
  events         Event[]
  reports        Report[]
  assets         VideoAsset[]
  app            App           @relation(fields: [appId], references: [id], onDelete: Cascade)
  creator        User          @relation("VideoCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  primaryAsset   VideoAsset?   @relation("VideoPrimaryAsset", fields: [primaryAssetId], references: [id])
  votes          Vote[]

  @@index([appId, status])
  @@index([appId, rankingScore(sort: Desc)])
  @@map("videos")
}

model VideoAsset {
  id              String   @id @default(uuid()) @db.Uuid
  appId           String   @map("app_id")
  videoId         String   @map("video_id") @db.Uuid
  assetType       String   @map("asset_type")
  variantLabel    String?  @map("variant_label")
  storageProvider String   @map("storage_provider")
  storageKey      String   @map("storage_key")
  cdnUrl          String   @map("cdn_url")
  mimeType        String?  @map("mime_type")
  width           Int?
  height          Int?
  bitrate         Int?
  fileSizeBytes   BigInt?  @map("file_size_bytes")
  isPrimary       Boolean  @default(false) @map("is_primary")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  app             App      @relation(fields: [appId], references: [id], onDelete: Cascade)
  video           Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  videoAsPrimary  Video[]  @relation("VideoPrimaryAsset")

  @@map("video_assets")
}

model Vote {
  id            String   @id @default(uuid()) @db.Uuid
  appId         String   @map("app_id")
  videoId       String   @map("video_id") @db.Uuid
  userId        String   @map("user_id")
  voteType      String   @map("vote_type")
  gestureSource String?  @map("gesture_source")
  requestId     String?  @map("request_id") // feed session id (string from client, e.g. req_...)
  rankPosition  Int?     @map("rank_position")
  feedMode      String?  @map("feed_mode")
  weight        Int
  isDenied      Boolean  @default(false) @map("is_denied")
  denyReason    String?  @map("deny_reason")
  createdAt     DateTime @default(now()) @map("created_at")
  app           App      @relation(fields: [appId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  video         Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([appId, userId, createdAt])
  @@index([appId, requestId])
  @@map("votes")
}

model Purchase {
  id                    String   @id @default(uuid()) @db.Uuid
  appId                 String   @map("app_id")
  userId                String   @map("user_id")
  purchaseType          String   @map("purchase_type")
  referenceId           String?  @map("reference_id") @db.Uuid
  provider              String
  providerTransactionId String   @map("provider_transaction_id")
  amountCents           Int      @map("amount_cents")
  currency              String   @default("USD")
  quantity              Int      @default(1)
  status                String
  metadata              Json?
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  app                   App      @relation(fields: [appId], references: [id], onDelete: Cascade)
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("purchases")
}

model Report {
  id         String   @id @default(uuid()) @db.Uuid
  appId      String   @map("app_id")
  reporterId String   @map("reporter_id")
  videoId    String   @map("video_id") @db.Uuid
  reason     String?
  status     String   @default("pending")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  app        App      @relation(fields: [appId], references: [id], onDelete: Cascade)
  reporter   User     @relation(fields: [reporterId], references: [id], onDelete: Cascade)
  video      Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@map("reports")
}

model Event {
  id               String   @id @default(uuid()) @db.Uuid
  appId            String   @map("app_id")
  userId           String?  @map("user_id")
  videoId          String?  @map("video_id") @db.Uuid
  requestId        String?  @map("request_id") // feed session id (string from client, e.g. req_...)
  rankPosition     Int?     @map("rank_position")
  feedMode         String?  @map("feed_mode")
  eventType        String   @map("event_type")
  eventName        String   @map("event_name")
  schemaVersion    Int      @map("schema_version")
  gestureDirection String?  @map("gesture_direction")
  gestureSource    String?  @map("gesture_source")
  properties       Json?
  createdAt        DateTime @default(now()) @map("created_at")
  app              App      @relation(fields: [appId], references: [id], onDelete: Cascade)
  user             User?    @relation(fields: [userId], references: [id])
  video            Video?   @relation(fields: [videoId], references: [id])

  @@index([appId, createdAt])
  @@index([requestId])
  @@map("events")
}
